name: ğŸ”„ Update Repository with All Versions (GitHub Actions Pages)

on:
  push:
    paths:
      - 'debs/**'
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'å¼ºåˆ¶é‡å»ºæ‰€æœ‰ç´¢å¼•'
        required: false
        default: 'false'

jobs:
  rebuild-index:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ“Š Check deb files
      run: |
        echo "=== æ£€æŸ¥debsæ–‡ä»¶å¤¹ ==="
        if [ ! -d "debs" ]; then
          echo "âŒ debsæ–‡ä»¶å¤¹ä¸å­˜åœ¨"
          mkdir -p debs
        fi
        
        echo "ğŸ“ æ–‡ä»¶å¤¹å†…å®¹ï¼š"
        ls -la debs/ || echo "ç©ºæ–‡ä»¶å¤¹"
        
        echo "ğŸ” æŸ¥æ‰¾æ‰€æœ‰.debæ–‡ä»¶ï¼š"
        find debs -name "*.deb" -type f | while read deb; do
          echo "  - $deb"
          # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          ls -lh "$deb"
        done
        
        COUNT=$(find debs -name "*.deb" -type f | wc -l)
        echo "âœ… æ€»å…±æ‰¾åˆ° $COUNT ä¸ª.debæ–‡ä»¶"
        
        if [ $COUNT -eq 0 ]; then
          echo "âš ï¸  è­¦å‘Šï¼šæ²¡æœ‰æ‰¾åˆ°.debæ–‡ä»¶"
        fi
    
    - name: ğŸ”§ Generate Packages with ALL versions
      run: |
        echo "=== ç”ŸæˆåŒ…å«æ‰€æœ‰ç‰ˆæœ¬çš„Packagesæ–‡ä»¶ ==="
        
        # ä¸ºGitHub Pagesåˆ›å»ºæ„å»ºç›®å½•
        rm -rf ./_pages_output
        mkdir -p ./_pages_output
        
        # å¦‚æœæ²¡æœ‰debæ–‡ä»¶ï¼Œåˆ›å»ºç©ºçš„Packages
        if [ ! -d "debs" ] || [ -z "$(find debs -name '*.deb' -print -quit)" ]; then
          echo "# Empty repository - waiting for packages" > ./_pages_output/Packages
          echo "æ²¡æœ‰æ‰¾åˆ°.debæ–‡ä»¶ï¼Œåˆ›å»ºç©ºç´¢å¼•"
        else
          echo "# Believess Repository" > ./_pages_output/Packages
          echo "# Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> ./_pages_output/Packages
          echo "# This file includes ALL versions of all packages" >> ./_pages_output/Packages
          echo "" >> ./_pages_output/Packages
          
          # ä½¿ç”¨dpkg-scanpackageså¤„ç†æ‰€æœ‰æ–‡ä»¶
          cd debs
          
          # ä¸ºæ¯ä¸ªdebæ–‡ä»¶å•ç‹¬å¤„ç†ï¼Œç¡®ä¿æ‰€æœ‰ç‰ˆæœ¬éƒ½è¢«åŒ…å«
          for DEB in *.deb; do
            if [ -f "$DEB" ]; then
              echo "ğŸ”¨ å¤„ç†: $DEB"
              
              # æå–åŒ…åç”¨äºä¸´æ—¶å¤„ç†
              PKG_NAME=$(echo "$DEB" | cut -d_ -f1)
              
              # åˆ›å»ºä¸€ä¸ªä¸´æ—¶ç›®å½•æ¥å¤„ç†è¿™ä¸ªdeb
              TEMP_DIR="/tmp/deb_$PKG_NAME"
              mkdir -p "$TEMP_DIR"
              cp "$DEB" "$TEMP_DIR/"
              
              # ç”Ÿæˆè¿™ä¸ªdebçš„æ¡ç›®
              dpkg-scanpackages "$TEMP_DIR" /dev/null 2>/dev/null | \
                sed "s|Filename: $TEMP_DIR/|Filename: ./debs/|" >> ../_pages_output/Packages
              
              # æ·»åŠ ç©ºè¡Œåˆ†éš”
              echo "" >> ../_pages_output/Packages
              
              rm -rf "$TEMP_DIR"
            fi
          done
          
          cd ..
          
          # æ‰‹åŠ¨éªŒè¯
          echo "ğŸ“Š ç”Ÿæˆçš„æ¡ç›®ç»Ÿè®¡ï¼š"
          echo "æ€»æ¡ç›®æ•°: $(grep -c '^Package:' ./_pages_output/Packages)"
          echo "å”¯ä¸€åŒ…å: $(grep '^Package:' ./_pages_output/Packages | sort -u | wc -l)"
          echo "æ‰€æœ‰ç‰ˆæœ¬:"
          grep '^Package:' ./_pages_output/Packages | sort | uniq -c
        fi
    
    - name: ğŸ—œï¸ Create compressed versions
      run: |
        echo "=== åˆ›å»ºå‹ç¼©æ–‡ä»¶ ==="
        
        if [ -f "./_pages_output/Packages" ]; then
          cd ./_pages_output
          
          # éªŒè¯æ–‡ä»¶å†…å®¹
          echo "ğŸ“„ Packagesæ–‡ä»¶å‰100ä¸ªå­—ç¬¦ï¼š"
          head -c 100 Packages
          echo ""
          
          echo "ğŸ“¦ åˆ›å»ºå‹ç¼©ç‰ˆæœ¬..."
          bzip2 -9fk Packages
          gzip -9fk Packages
          
          echo "ğŸ“Š æ–‡ä»¶å¤§å°ï¼š"
          ls -lh Packages*
          
          # åˆ›å»ºç‰ˆæœ¬æ¸…å•
          echo "# Version Manifest" > VERSIONS.txt
          echo "Repository: believess" >> VERSIONS.txt
          echo "Updated: $(date)" >> VERSIONS.txt
          echo "" >> VERSIONS.txt
          echo "Available Packages:" >> VERSIONS.txt
          awk '/^Package:/ {pkg=$2} /^Version:/ {ver=$2} /^$/ {if(pkg && ver) print pkg " " ver; pkg=""; ver=""}' Packages | \
            sort >> VERSIONS.txt
          
          cd ..
        else
          echo "âŒ Packagesæ–‡ä»¶ä¸å­˜åœ¨"
          cd ./_pages_output
          touch Packages.bz2 Packages.gz
          cd ..
        fi
    
    - name: ğŸ“ Create debug info
      run: |
        echo "=== è°ƒè¯•ä¿¡æ¯ ===" > ./_pages_output/DEBUG.md
        echo "ç”Ÿæˆæ—¶é—´: $(date)" >> ./_pages_output/DEBUG.md
        echo "éƒ¨ç½²æ¨¡å¼: GitHub Actions Pages" >> ./_pages_output/DEBUG.md
        echo "" >> ./_pages_output/DEBUG.md
        
        echo "**debsæ–‡ä»¶å¤¹å†…å®¹ï¼š**" >> ./_pages_output/DEBUG.md
        echo '```' >> ./_pages_output/DEBUG.md
        ls -la debs/ >> ./_pages_output/DEBUG.md 2>/dev/null || echo "ç©ºæ–‡ä»¶å¤¹" >> ./_pages_output/DEBUG.md
        echo '```' >> ./_pages_output/DEBUG.md
        echo "" >> ./_pages_output/DEBUG.md
        
        echo "**Packagesæ–‡ä»¶ç»Ÿè®¡ï¼š**" >> ./_pages_output/DEBUG.md
        if [ -f "./_pages_output/Packages" ]; then
          echo "- æ€»è¡Œæ•°: $(wc -l < ./_pages_output/Packages)" >> ./_pages_output/DEBUG.md
          echo "- åŒ…æ¡ç›®: $(grep -c '^Package:' ./_pages_output/Packages)" >> ./_pages_output/DEBUG.md
          echo "- ç‰ˆæœ¬æ•°: $(grep -c '^Version:' ./_pages_output/Packages)" >> ./_pages_output/DEBUG.md
          echo "" >> ./_pages_output/DEBUG.md
          echo "**æ‰€æœ‰åŒ…å’Œç‰ˆæœ¬ï¼š**" >> ./_pages_output/DEBUG.md
          echo '```' >> ./_pages_output/DEBUG.md
          awk '/^Package:/ {pkg=$2} /^Version:/ {ver=$2} /^$/ {if(pkg && ver) printf "%-30s %s\n", pkg, ver; pkg=""; ver=""}' ./_pages_output/Packages | \
            sort >> ./_pages_output/DEBUG.md
          echo '```' >> ./_pages_output/DEBUG.md
        else
          echo "Packagesæ–‡ä»¶æœªç”Ÿæˆ" >> ./_pages_output/DEBUG.md
        fi
        
        # æ·»åŠ .nojekyllæ–‡ä»¶ï¼ˆé‡è¦ï¼ï¼‰
        touch ./_pages_output/.nojekyll
        
        echo "" >> ./_pages_output/DEBUG.md
        echo "**GitHub Pagesä¿¡æ¯ï¼š**" >> ./_pages_output/DEBUG.md
        echo "- æºåœ°å€: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> ./_pages_output/DEBUG.md
        echo "- éƒ¨ç½²æ—¶é—´: $(date)" >> ./_pages_output/DEBUG.md
    
    - name: ğŸ—ï¸ Configure GitHub Pages
      uses: actions/configure-pages@v4
    
    - name: ğŸ“¤ Upload to GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: './_pages_output'
    
    - name: ğŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: âœ… éƒ¨ç½²å®ŒæˆéªŒè¯
      run: |
        echo "=== éƒ¨ç½²æˆåŠŸ ==="
        echo "âœ… è½¯ä»¶æºå·²éƒ¨ç½²åˆ° GitHub Pages!"
        echo ""
        echo "ğŸ“¦ åŒ…å«çš„åŒ…æ•°é‡: $(grep -c '^Package:' ./_pages_output/Packages 2>/dev/null || echo '0')"
        echo ""
        echo "ğŸŒ è®¿é—®åœ°å€: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        echo "ğŸ“„ Packagesæ–‡ä»¶: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/Packages"
        echo ""
        echo "ğŸ¯ åœ¨Sileoä¸­æ·»åŠ ä»¥ä¸‹æºåœ°å€:"
        echo "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        echo ""
        echo "ğŸ”„ ä¸‹æ¬¡æ›´æ–°åªéœ€ä¸Šä¼ .debæ–‡ä»¶åˆ°debs/ç›®å½•å³å¯è‡ªåŠ¨éƒ¨ç½²"
