name: ğŸ”„ æ„å»ºiOSè¶Šç‹±è½¯ä»¶æº (GitHub Actions Pages)

on:
  push:
    paths:
      - 'debs/**'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ› ï¸ å®‰è£…å¿…è¦å·¥å…·
      run: |
        sudo apt-get update
        sudo apt-get install -y dpkg-dev
    
    - name: ğŸ“¦ æ„å»ºæ ‡å‡†è½¯ä»¶æºç»“æ„
      run: |
        echo "=== æ„å»ºiOSè¶Šç‹±è½¯ä»¶æºç»“æ„ ==="
        
        # åˆ›å»ºæ„å»ºç›®å½•
        rm -rf ./_repo_build
        mkdir -p ./_repo_build
        
        # åˆ›å»ºæ ‡å‡†ç›®å½•ç»“æ„ (Sileo/Cydiaå¿…éœ€)
        mkdir -p ./_repo_build/dists/ios/main/binary-iphoneos-arm
        mkdir -p ./_repo_build/dists/ios/main/binary-iphoneos-arm64
        
        # å¤åˆ¶debæ–‡ä»¶åˆ°poolç›®å½• (å¯é€‰ä½†æ ‡å‡†)
        mkdir -p ./_repo_build/pool/main
        if [ -d "debs" ] && [ -n "$(ls debs/*.deb 2>/dev/null)" ]; then
          cp debs/*.deb ./_repo_build/pool/main/
        fi
        
        # ç”ŸæˆPackagesæ–‡ä»¶ (å…³é”®æ­¥éª¤)
        echo "ğŸ”¨ ç”ŸæˆPackagesæ–‡ä»¶..."
        if [ -d "debs" ] && [ -n "$(ls debs/*.deb 2>/dev/null)" ]; then
          dpkg-scanpackages debs /dev/null > ./_repo_build/dists/ios/main/binary-iphoneos-arm/Packages
        else
          echo "# Empty repository" > ./_repo_build/dists/ios/main/binary-iphoneos-arm/Packages
        fi
        
        # å¤åˆ¶åˆ°arm64ç›®å½• (é€šå¸¸å†…å®¹ç›¸åŒ)
        cp ./_repo_build/dists/ios/main/binary-iphoneos-arm/Packages ./_repo_build/dists/ios/main/binary-iphoneos-arm64/
        
        # åˆ›å»ºå‹ç¼©ç‰ˆæœ¬
        cd ./_repo_build/dists/ios/main/binary-iphoneos-arm
        gzip -9fk < Packages > Packages.gz
        bzip2 -9fk < Packages > Packages.bz2
        cd ../../../../../..
        
        cd ./_repo_build/dists/ios/main/binary-iphoneos-arm64
        gzip -9fk < Packages > Packages.gz
        bzip2 -9fk < Packages > Packages.bz2
        cd ../../../../../..
        
        # åˆ›å»ºReleaseæ–‡ä»¶ (Sileo/Cydiaå¿…éœ€!)
        echo "ğŸ—ï¸ åˆ›å»ºReleaseæ–‡ä»¶..."
        cat > ./_repo_build/dists/ios/Release << 'EOF'
Origin: believess
Label: believess Repository
Suite: ios
Codename: ios
Version: 1.0
Architectures: iphoneos-arm iphoneos-arm64
Components: main
Description: believess iOS Repository
EOF
        
        # è®¡ç®—å“ˆå¸Œå€¼å¹¶æ·»åŠ åˆ°Releaseæ–‡ä»¶
        echo "MD5Sum:" >> ./_repo_build/dists/ios/Release
        for file in Packages Packages.gz Packages.bz2; do
          for arch in binary-iphoneos-arm binary-iphoneos-arm64; do
            if [ -f "./_repo_build/dists/ios/main/$arch/$file" ]; then
              md5=$(md5sum "./_repo_build/dists/ios/main/$arch/$file" | cut -d' ' -f1)
              size=$(stat -c%s "./_repo_build/dists/ios/main/$arch/$file")
              echo " $md5 $size main/$arch/$file" >> ./_repo_build/dists/ios/Release
            fi
          done
        done
        
        echo "SHA256:" >> ./_repo_build/dists/ios/Release
        for file in Packages Packages.gz Packages.bz2; do
          for arch in binary-iphoneos-arm binary-iphoneos-arm64; do
            if [ -f "./_repo_build/dists/ios/main/$arch/$file" ]; then
              sha256=$(sha256sum "./_repo_build/dists/ios/main/$arch/$file" | cut -d' ' -f1)
              size=$(stat -c%s "./_repo_build/dists/ios/main/$arch/$file")
              echo " $sha256 $size main/$arch/$file" >> ./_repo_build/dists/ios/Release
            fi
          done
        done
        
        # åˆ›å»º.nojekyllæ–‡ä»¶é˜²æ­¢GitHubå¤„ç†é”™è¯¯
        touch ./_repo_build/.nojekyll
        
        echo "ğŸ“ æœ€ç»ˆç›®å½•ç»“æ„:"
        find ./_repo_build -type f | sort
        
        echo "ğŸ“¦ åŒ…å«çš„è½¯ä»¶åŒ…:"
        if [ -f "./_repo_build/dists/ios/main/binary-iphoneos-arm/Packages" ]; then
          grep "^Package: " ./_repo_build/dists/ios/main/binary-iphoneos-arm/Packages | sort
        fi
    
    - name: ğŸ—ï¸ é…ç½®GitHub Pages
      uses: actions/configure-pages@v4
    
    - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-pages-artifact@v3
      with:
        path: './_repo_build'
    
    - name: ğŸš€ éƒ¨ç½²åˆ°GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: âœ… éªŒè¯éƒ¨ç½²
      run: |
        echo "=== éƒ¨ç½²éªŒè¯ ==="
        echo "âœ… è½¯ä»¶æºå·²éƒ¨ç½²!"
        echo ""
        echo "ğŸŒ è®¿é—®ä»¥ä¸‹é“¾æ¥éªŒè¯:"
        echo "1. Releaseæ–‡ä»¶: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/dists/ios/Release"
        echo "2. Packagesæ–‡ä»¶: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/dists/ios/main/binary-iphoneos-arm/Packages"
        echo ""
        echo "ğŸ¯ Sileoæºåœ°å€ (åœ¨è®¾å¤‡ä¸Šæ·»åŠ ):"
        echo "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
