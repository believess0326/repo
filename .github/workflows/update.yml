name: ğŸ”„ Build iOS Repository for GitHub Pages

on:
  push:
    paths:
      - 'debs/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ“Š Check deb files
      run: |
        echo "=== æ£€æŸ¥debsæ–‡ä»¶å¤¹ ==="
        if [ ! -d "debs" ]; then
          echo "åˆ›å»ºdebsæ–‡ä»¶å¤¹"
          mkdir -p debs
        fi
        
        COUNT=$(find debs -name "*.deb" -type f | wc -l)
        echo "æ‰¾åˆ° $COUNT ä¸ª.debæ–‡ä»¶"
        
        if [ $COUNT -gt 0 ]; then
          echo "ğŸ“¦ åŒ…åˆ—è¡¨:"
          find debs -name "*.deb" -type f -exec basename {} \;
        fi
    
    - name: ğŸ”§ Build repository structure
      run: |
        echo "=== æ„å»ºSileoå…¼å®¹çš„ä»“åº“ç»“æ„ ==="
        
        # æ¸…ç†å¹¶åˆ›å»ºæ„å»ºç›®å½•
        rm -rf ./_build
        mkdir -p ./_build
        
        # æ–¹æ³•1ï¼šç›´æ¥å¤åˆ¶debæ–‡ä»¶åˆ°æ„å»ºç›®å½•
        if [ -d "debs" ] && [ -n "$(ls debs/*.deb 2>/dev/null)" ]; then
          echo "å¤åˆ¶debæ–‡ä»¶..."
          mkdir -p ./_build/debs
          cp debs/*.deb ./_build/debs/
        fi
        
        # æ–¹æ³•2ï¼šåˆ›å»ºiOSè¶Šç‹±æºæ ‡å‡†ç»“æ„
        echo "åˆ›å»ºiOSè¶Šç‹±æºæ ‡å‡†ç»“æ„..."
        mkdir -p ./_build/dists/ios
        mkdir -p ./_build/dists/ios/main
        mkdir -p ./_build/dists/ios/main/binary-iphoneos-arm
        mkdir -p ./_build/dists/ios/main/binary-iphoneos-arm64
        
        # ç”ŸæˆPackagesæ–‡ä»¶
        echo "ç”ŸæˆPackagesæ–‡ä»¶..."
        if [ -d "debs" ] && [ -n "$(ls debs/*.deb 2>/dev/null)" ]; then
          # ä½¿ç”¨ç®€å•æ–¹æ³•ç”ŸæˆPackages
          dpkg-scanpackages debs /dev/null > ./_build/Packages
          cp ./_build/Packages ./_build/dists/ios/main/binary-iphoneos-arm/Packages
          cp ./_build/Packages ./_build/dists/ios/main/binary-iphoneos-arm64/Packages
        else
          echo "# Empty repository" > ./_build/Packages
          cp ./_build/Packages ./_build/dists/ios/main/binary-iphoneos-arm/Packages
          cp ./_build/Packages ./_build/dists/ios/main/binary-iphoneos-arm64/Packages
        fi
        
        # åˆ›å»ºå‹ç¼©ç‰ˆæœ¬
        echo "åˆ›å»ºå‹ç¼©ç‰ˆæœ¬..."
        cd ./_build
        gzip -9fk < Packages > Packages.gz
        bzip2 -9fk < Packages > Packages.bz2
        
        # å¤åˆ¶å‹ç¼©ç‰ˆæœ¬åˆ°å„æ¶æ„ç›®å½•
        for arch_dir in dists/ios/main/binary-iphoneos-arm dists/ios/main/binary-iphoneos-arm64; do
          cp Packages.gz "$arch_dir/"
          cp Packages.bz2 "$arch_dir/"
        done
        
        # åˆ›å»ºReleaseæ–‡ä»¶ï¼ˆSileoå¿…éœ€ï¼‰
        echo "åˆ›å»ºReleaseæ–‡ä»¶..."
        cat > dists/ios/Release << 'RELEASE_EOF'
Origin: believess
Label: believess Repository
Suite: stable
Codename: ios
Architectures: iphoneos-arm iphoneos-arm64
Components: main
Description: believess iOS Repository
RELEASE_EOF
        
        # è®¡ç®—å“ˆå¸Œå€¼
        echo "è®¡ç®—æ–‡ä»¶å“ˆå¸Œ..."
        echo "MD5Sum:" >> dists/ios/Release
        for file in Packages Packages.gz Packages.bz2; do
          for arch in binary-iphoneos-arm binary-iphoneos-arm64; do
            if [ -f "dists/ios/main/$arch/$file" ]; then
              md5=$(md5sum "dists/ios/main/$arch/$file" | cut -d' ' -f1)
              size=$(wc -c < "dists/ios/main/$arch/$file")
              echo " $md5 $size main/$arch/$file" >> dists/ios/Release
            fi
          done
        done
        
        echo "SHA256:" >> dists/ios/Release
        for file in Packages Packages.gz Packages.bz2; do
          for arch in binary-iphoneos-arm binary-iphoneos-arm64; do
            if [ -f "dists/ios/main/$arch/$file" ]; then
              sha256=$(sha256sum "dists/ios/main/$arch/$file" | cut -d' ' -f1)
              size=$(wc -c < "dists/ios/main/$arch/$file")
              echo " $sha256 $size main/$arch/$file" >> dists/ios/Release
            fi
          done
        done
        
        # åˆ›å»º.nojekyllæ–‡ä»¶
        touch .nojekyll
        
        echo "âœ… æ„å»ºå®Œæˆï¼"
        echo "ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶:"
        find . -type f | sort
        
        # æ˜¾ç¤ºåŒ…å«çš„åŒ…
        echo "ğŸ“¦ åŒ…å«çš„åŒ…:"
        if [ -f "Packages" ]; then
          grep "^Package: " Packages | sort | uniq
        fi
    
    - name: ğŸ—ï¸ Configure GitHub Pages
      uses: actions/configure-pages@v4
    
    - name: ğŸ“¤ Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './_build'
    
    - name: ğŸš€ Deploy to GitHub Pages
      uses: actions/deploy-pages@v4
    
    - name: âœ… Verify deployment
      run: |
        echo "=== éƒ¨ç½²éªŒè¯ ==="
        echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
        echo ""
        echo "ğŸŒ è®¿é—®ä»¥ä¸‹é“¾æ¥éªŒè¯:"
        echo "1. æ ¹ç›®å½•Packages: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/Packages"
        echo "2. iOSç»“æ„Packages: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/dists/ios/main/binary-iphoneos-arm/Packages"
        echo "3. Releaseæ–‡ä»¶: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/dists/ios/Release"
        echo ""
        echo "ğŸ¯ Sileoæºåœ°å€ï¼ˆå°è¯•ä»¥ä¸‹ä»»ä¸€ï¼‰:"
        echo "A. https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        echo "B. https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/dists/ios/"
        echo ""
        echo "ğŸ“± åœ¨Sileoä¸­ï¼š"
        echo "1. åˆ é™¤æ—§æºï¼ˆå¦‚æœå­˜åœ¨ï¼‰"
        echo "2. æ·»åŠ ä¸Šè¿°ä»»ä¸€åœ°å€"
        echo "3. ä¸‹æ‹‰åˆ·æ–°"
